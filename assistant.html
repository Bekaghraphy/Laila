<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LAILA | AI Assistant</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-main:#0e0f14; --bg-soft:#151722;
      --accent:#8b8df8; --accent-soft:#6f72e6;
      --text:#ffffff; --muted:rgba(255,255,255,0.74);
      --border:rgba(255,255,255,0.08);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --radius:18px; --radius-lg:22px;
      --ease:cubic-bezier(.2,.8,.2,1);
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Montserrat",sans-serif;}
    body{
      background:radial-gradient(circle at top,#1a1c2d,var(--bg-main));
      color:var(--text);
      min-height:100vh;overflow-x:hidden;
    }
    .bg-glow{
      position:fixed;inset:-200px;background:
      radial-gradient(closest-side, rgba(139,141,248,0.14), transparent 60%) 10% 20%/520px 520px,
      radial-gradient(closest-side, rgba(111,114,230,0.10), transparent 60%) 85% 30%/560px 560px,
      radial-gradient(closest-side, rgba(139,141,248,0.08), transparent 60%) 50% 95%/620px 620px;
      pointer-events:none;z-index:-1;animation:floatGlow 10s var(--ease) infinite alternate;opacity:.9;
    }
    @keyframes floatGlow{from{transform:translate3d(0,0,0) scale(1);}to{transform:translate3d(0,-18px,0) scale(1.03);}}

    header{
      position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;border-bottom:1px solid var(--border);
      background:rgba(14,15,20,0.70);backdrop-filter:blur(14px);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:2px;font-size:1.05rem;user-select:none;}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-soft));
      box-shadow:0 0 0 6px rgba(139,141,248,0.12),0 0 26px rgba(139,141,248,0.35);}
    nav{display:none;align-items:center;gap:18px;}
    nav a{color:var(--muted);text-decoration:none;font-size:0.92rem;padding:10px 10px;border-radius:999px;
      transition:transform .18s var(--ease),color .18s var(--ease),background .18s var(--ease);}
    nav a:hover{color:var(--text);background:rgba(255,255,255,0.04);transform:translateY(-1px);box-shadow:0 0 0 1px rgba(139,141,248,0.14) inset;}
    nav a.active{color:var(--text);background:rgba(139,141,248,0.10);box-shadow:0 0 0 1px rgba(139,141,248,0.22) inset,0 14px 38px rgba(0,0,0,0.35);}

    .right{display:flex;align-items:center;gap:10px;}
    .lang button,.menu-btn{
      border:1px solid var(--border);background:rgba(255,255,255,0.02);color:var(--text);
      padding:8px 12px;border-radius:999px;font-size:0.82rem;cursor:pointer;position:relative;overflow:hidden;
      transition:transform .18s var(--ease),box-shadow .18s var(--ease),background .18s var(--ease),border-color .18s var(--ease);
    }
    .lang button.active{border-color:transparent;background:linear-gradient(135deg,var(--accent),var(--accent-soft));box-shadow:0 16px 50px rgba(139,141,248,0.22);}
    .lang button:hover,.menu-btn:hover{transform:translateY(-1px);box-shadow:0 0 0 1px rgba(139,141,248,0.16) inset,0 18px 60px rgba(0,0,0,0.35);}

    .tap-glow::after{
      content:"";position:absolute;inset:-60%;background:radial-gradient(circle,rgba(139,141,248,0.55),transparent 60%);
      transform:scale(0.2);opacity:0;animation:tap 520ms var(--ease) forwards;pointer-events:none;
    }
    @keyframes tap{0%{opacity:0;transform:scale(0.15);}35%{opacity:0.65;transform:scale(0.55);}100%{opacity:0;transform:scale(1.05);}}

    .menu-btn{display:inline-flex;align-items:center;gap:8px;}
    .menu-panel{
      position:fixed;top:68px;left:16px;right:16px;background:rgba(21,23,34,0.92);border:1px solid var(--border);
      border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:12px;display:none;backdrop-filter:blur(16px);
    }
    .menu-panel a{display:block;padding:12px 12px;border-radius:14px;color:var(--muted);text-decoration:none;
      transition:background .18s var(--ease),color .18s var(--ease),transform .18s var(--ease);}
    .menu-panel a:hover{background:rgba(255,255,255,0.04);color:var(--text);transform:translateY(-1px);box-shadow:0 0 0 1px rgba(139,141,248,0.14) inset;}
    .menu-panel a.active{color:var(--text);background:rgba(139,141,248,0.10);box-shadow:0 0 0 1px rgba(139,141,248,0.22) inset;}

    main{max-width:1180px;margin:0 auto;padding:26px 18px 80px;}
    .fade-in{animation:fadeIn 520ms var(--ease) both;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}

    .layout{display:grid;grid-template-columns:1fr;gap:14px;align-items:start;}
    .panel{
      background:rgba(21,23,34,0.86);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel-header{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .panel-title{font-weight:700;letter-spacing:.6px;}
    .panel-sub{color:var(--muted);font-size:.88rem;margin-top:6px;line-height:1.6;}
    .panel-body{padding:14px 16px;}

    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;}
    .chip{
      border:1px solid var(--border);
      background:rgba(255,255,255,0.02);
      color:var(--text);
      padding:8px 12px;border-radius:999px;
      cursor:pointer;font-size:.85rem;
      transition:transform .18s var(--ease),box-shadow .18s var(--ease),background .18s var(--ease);
      user-select:none;
    }
    .chip:hover{transform:translateY(-1px);box-shadow:0 0 0 1px rgba(139,141,248,0.16) inset,0 18px 60px rgba(0,0,0,0.35);background:rgba(139,141,248,0.08);}

    .chat{
      height:520px;
      overflow:auto;
      padding:14px 14px 8px;
      scroll-behavior:smooth;
    }
    .msg{display:flex;margin:10px 0;}
    .msg.user{justify-content:flex-end;}
    .bubble{
      max-width:82%;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      border-radius:18px;
      padding:12px 12px;
      line-height:1.75;
      box-shadow:0 12px 40px rgba(0,0,0,0.22);
      position:relative;
      overflow:hidden;
    }
    .msg.user .bubble{
      background:rgba(139,141,248,0.10);
      border-color:rgba(139,141,248,0.20);
    }
    .meta-row{
      margin-top:10px;
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;
    }
    .badge{
      font-size:.78rem;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.02);
      color:var(--muted);
    }
    .badge.strong{color:var(--text);border-color:rgba(139,141,248,0.22);background:rgba(139,141,248,0.08);}
    .links{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
    .alink{
      display:inline-flex;gap:8px;align-items:center;
      text-decoration:none;color:var(--text);
      border:1px solid rgba(139,141,248,0.20);
      background:rgba(139,141,248,0.08);
      padding:8px 10px;border-radius:14px;
      transition:transform .18s var(--ease),box-shadow .18s var(--ease);
      font-size:.85rem;
    }
    .alink:hover{transform:translateY(-1px);box-shadow:0 0 0 1px rgba(139,141,248,0.16) inset,0 18px 60px rgba(0,0,0,0.35);}

    .composer{
      border-top:1px solid rgba(255,255,255,0.06);
      padding:12px;
      display:flex;gap:10px;align-items:center;
      background:rgba(14,15,20,0.35);
      backdrop-filter:blur(12px);
    }
    .input{
      flex:1;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.02);
      color:var(--text);
      padding:12px 12px;
      border-radius:999px;
      outline:none;
      font-size:.95rem;
    }
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(135deg,var(--accent),var(--accent-soft));
      color:var(--text);
      padding:12px 18px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      transition:transform .18s var(--ease),box-shadow .18s var(--ease);
      min-width:108px;
      position:relative;
      overflow:hidden;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 0 0 1px rgba(139,141,248,0.16) inset,0 18px 60px rgba(0,0,0,0.35);}

    /* Gymnast Loader */
    .loaderWrap{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border:1px solid rgba(139,141,248,0.18);
      background:rgba(139,141,248,0.06);
      border-radius:16px;
    }
    .loaderRow{display:flex;gap:12px;align-items:center;}
    .gymLoader{
      width:42px;height:42px;border-radius:14px;
      position:relative;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
      overflow:hidden;
    }
    .gymLoader::before{
      content:"";
      position:absolute;left:50%;top:50%;
      width:10px;height:10px;border-radius:50%;
      background:rgba(139,141,248,0.95);
      transform:translate(-50%,-50%);
      animation:dotSpin 1.1s linear infinite;
      box-shadow:0 0 20px rgba(139,141,248,0.45);
    }
    .gymLoader::after{
      content:"";
      position:absolute;inset:-30%;
      background:conic-gradient(from 90deg, rgba(139,141,248,0.0), rgba(139,141,248,0.35), rgba(139,141,248,0.0));
      animation:ribbon 1.1s linear infinite;
      opacity:.9;
    }
    @keyframes dotSpin{
      0%{transform:translate(-50%,-50%) rotate(0deg) translateX(12px) rotate(0deg);}
      100%{transform:translate(-50%,-50%) rotate(360deg) translateX(12px) rotate(-360deg);}
    }
    @keyframes ribbon{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .loaderText{color:var(--muted);font-size:.92rem;line-height:1.6}

    .tinyToggle{
      margin-top:10px;
      color:var(--muted);
      font-size:.85rem;
      cursor:pointer;
      user-select:none;
    }
    .tinyToggle:hover{color:var(--text);}

    .miniSearch{
      display:flex;gap:10px;align-items:center;margin-top:10px;
    }
    .miniSearch input{
      flex:1;border:1px solid var(--border);
      background:rgba(255,255,255,0.02);
      color:var(--text);
      padding:10px 12px;border-radius:999px;outline:none;
      font-size:.9rem;
    }
    .miniList{margin-top:10px;display:flex;flex-direction:column;gap:8px;}
    .miniItem{
      border:1px solid var(--border);
      background:rgba(255,255,255,0.02);
      padding:10px 12px;border-radius:14px;
      color:var(--muted);
      display:flex;justify-content:space-between;gap:10px;align-items:center;
    }
    .miniItem a{color:var(--text);text-decoration:none}
    .miniItem a:hover{text-decoration:underline;}

    @media(min-width:980px){
      header{padding:16px 26px;}
      nav{display:flex;}
      .menu-btn{display:none;}
      .menu-panel{display:none !important;}
      main{padding:28px 26px 90px;}
      .layout{grid-template-columns: 1fr 1.6fr;}
      .chat{height:600px;}
    }
  </style>
</head>

<body>
  <div class="bg-glow"></div>

  <header>
    <div class="brand"><span class="dot"></span><span>LAILA</span></div>

    <nav>
      <a href="index.html" data-route="index.html">Home</a>
      <a href="archive.html" data-route="archive.html">Archive</a>
      <a href="learn.html" data-route="learn.html">Learn</a>
      <a href="assistant.html" data-route="assistant.html">AI Assistant</a>
    </nav>

    <div class="right">
      <button class="menu-btn" id="menuBtn" type="button">Menu</button>
      <div class="lang">
        <button id="btn-en" type="button">EN</button>
        <button id="btn-ar" type="button">AR</button>
      </div>
    </div>
  </header>

  <div class="menu-panel" id="menuPanel">
    <a href="index.html" data-route="index.html">Home</a>
    <a href="archive.html" data-route="archive.html">Archive</a>
    <a href="learn.html" data-route="learn.html">Learn</a>
    <a href="assistant.html" data-route="assistant.html">AI Assistant</a>
  </div>

  <main class="fade-in">
    <div class="layout">

      <!-- LEFT PANEL -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title" id="leftTitle">How LAILA helps</div>
            <div class="panel-sub" id="leftSub">
              Ask in your own words — LAILA will answer using the archive, with level + era + internal sources.
            </div>
          </div>
        </div>
        <div class="panel-body">
          <div class="chips" id="chips"></div>

          <div class="miniSearch">
            <input id="archiveSearch" placeholder="Search inside the Archive links..." />
          </div>
          <div class="miniList" id="miniList"></div>

          <div class="tinyToggle" id="toggleBilingual">Show bilingual answers</div>
          <div class="loaderWrap" id="loaderWrap">
            <div class="loaderRow">
              <div class="gymLoader"></div>
              <div class="loaderText" id="loaderText">LAILA is thinking…</div>
            </div>
          </div>
        </div>
      </section>

      <!-- CHAT PANEL -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title" id="chatTitle">Ask LAILA</div>
            <div class="panel-sub" id="chatSub">
              Rhythmic Gymnastics intelligence — history, judging, training, apparatus, and athletes.
            </div>
          </div>
        </div>

        <div class="chat" id="chat"></div>

        <div class="composer">
          <input class="input" id="questionInput" placeholder="Type your question here…" />
          <button class="btn" id="sendBtn" type="button">Ask</button>
        </div>
      </section>

    </div>
  </main>

  <script>
    // IMPORTANT: ضع رابط الـVercel API هنا
    const API_ENDPOINT = "https://laila-ai-backend.vercel.app/api/laila";

    const STORAGE_KEY = "laila_lang";
    const STORAGE_BI = "laila_bilingual";

    const ui = {
      ar: {
        leftTitle: "المساعد إزاي بيساعدك",
        leftSub: "اسأل بطريقتك — ليلى هترد اعتمادًا على الأرشيف، ومع مستوى + حقبة + مصادر داخلية.",
        chatTitle: "اسأل ليلى",
        chatSub: "ذكاء الجمباز الإيقاعي — تاريخ، تحكيم، تدريب، أدوات، ولاعبات.",
        placeholder: "اكتب سؤالك هنا…",
        ask: "اسأل",
        thinking: "ليلى بتفكر…",
        showBi: "عرض الإجابة بلغتين",
        hideBi: "إخفاء الترجمة",
        searchPH: "ابحث داخل روابط الأرشيف…",
        chips: [
          { label: "التحكيم / Judging", q: "اشرح نظام التحكيم D/E/A ببساطة" },
          { label: "التدريب / Training", q: "عايز خطة تدريب مبتدئ لمدة 4 أسابيع" },
          { label: "الأدوات / Apparatus", q: "إيه الفرق بين الشريط والطوق في الصعوبة؟" },
          { label: "التاريخ / History", q: "إزاي بدأ الجمباز الإيقاعي واتطور؟" },
          { label: "لاعبات / Gymnasts", q: "مين أبرز اللاعبات وتأثيرهم على اللعبة؟" }
        ],
        levelLabel: "المستوى",
        eraLabel: "الحقبة",
        sourcesLabel: "مصادر داخل الأرشيف",
        linksLabel: "اقرأ أكتر",
        noAnswer: "مافيش إجابة واضحة من الأرشيف. جرّب تسأل بصياغة أدق."
      },
      en: {
        leftTitle: "How LAILA helps",
        leftSub: "Ask in your own words — LAILA answers from the archive with level + era + internal sources.",
        chatTitle: "Ask LAILA",
        chatSub: "Rhythmic Gymnastics intelligence — history, judging, training, apparatus, athletes.",
        placeholder: "Type your question here…",
        ask: "Ask",
        thinking: "LAILA is thinking…",
        showBi: "Show bilingual answers",
        hideBi: "Hide translation",
        searchPH: "Search inside the Archive links…",
        chips: [
          { label: "Judging", q: "Explain D/E/A judging in a simple way" },
          { label: "Training", q: "Make a 4-week beginner training roadmap" },
          { label: "Apparatus", q: "What’s the difference between ribbon and hoop difficulty?" },
          { label: "History", q: "How did rhythmic gymnastics start and evolve?" },
          { label: "Gymnasts", q: "Who are influential gymnasts and why?" }
        ],
        levelLabel: "Level",
        eraLabel: "Era",
        sourcesLabel: "Archive sources",
        linksLabel: "Read more",
        noAnswer: "No clear archive answer. Try a more specific wording."
      }
    };

    const linkIndex = [
      { ar: "تاريخ اللعبة", en: "History", url: "history.html" },
      { ar: "دليل الأدوات", en: "Apparatus", url: "apparatus.html" },
      { ar: "تطور القوانين", en: "Rules", url: "rules.html" },
      { ar: "التحكيم", en: "Judging", url: "judging.html" },
      { ar: "التدريب", en: "Training", url: "training.html" },
      { ar: "لاعبات مؤثرات", en: "Gymnasts", url: "gymnasts.html" },
      { ar: "الأرشيف", en: "Archive", url: "archive.html" }
    ];

    function addTapGlow(el){
      el.classList.remove("tap-glow");
      void el.offsetWidth;
      el.classList.add("tap-glow");
      setTimeout(()=> el.classList.remove("tap-glow"), 560);
    }

    function setLang(lang, persist=true){
      document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";
      document.documentElement.lang = (lang === "ar") ? "ar" : "en";

      document.getElementById("btn-en").classList.toggle("active", lang === "en");
      document.getElementById("btn-ar").classList.toggle("active", lang === "ar");

      const t = ui[lang];
      document.getElementById("leftTitle").textContent = t.leftTitle;
      document.getElementById("leftSub").textContent = t.leftSub;
      document.getElementById("chatTitle").textContent = t.chatTitle;
      document.getElementById("chatSub").textContent = t.chatSub;
      document.getElementById("questionInput").placeholder = t.placeholder;
      document.getElementById("sendBtn").textContent = t.ask;
      document.getElementById("loaderText").textContent = t.thinking;
      document.getElementById("archiveSearch").placeholder = t.searchPH;

      renderChips(lang);
      renderMiniList(lang, document.getElementById("archiveSearch").value || "");

      const bilingual = localStorage.getItem(STORAGE_BI) === "1";
      document.getElementById("toggleBilingual").textContent = bilingual ? t.hideBi : t.showBi;

      if(persist) localStorage.setItem(STORAGE_KEY, lang);
    }

    function highlightActiveRoute(){
      const file = (location.pathname.split("/").pop() || "index.html").toLowerCase();
      document.querySelectorAll("[data-route]").forEach(a=>{
        a.classList.toggle("active", a.getAttribute("data-route").toLowerCase() === file);
      });
    }

    const menuBtn = document.getElementById("menuBtn");
    const menuPanel = document.getElementById("menuPanel");
    function toggleMenu(){
      const open = menuPanel.style.display === "block";
      menuPanel.style.display = open ? "none" : "block";
    }
    menuBtn?.addEventListener("click", ()=>{
      addTapGlow(menuBtn);
      toggleMenu();
    });
    document.addEventListener("click", (e)=>{
      const inside = menuPanel.contains(e.target) || menuBtn.contains(e.target);
      if(!inside) menuPanel.style.display = "none";
    });

    document.querySelectorAll("button, a").forEach(el=>{
      el.addEventListener("click", ()=> addTapGlow(el));
    });

    function renderChips(lang){
      const wrap = document.getElementById("chips");
      wrap.innerHTML = "";
      ui[lang].chips.forEach(item=>{
        const b = document.createElement("div");
        b.className = "chip";
        b.textContent = item.label;
        b.onclick = ()=>{
          addTapGlow(b);
          document.getElementById("questionInput").value = item.q;
          document.getElementById("questionInput").focus();
        };
        wrap.appendChild(b);
      });
    }

    function renderMiniList(lang, q){
      const list = document.getElementById("miniList");
      list.innerHTML = "";
      const query = (q || "").toLowerCase().trim();
      const items = linkIndex.filter(x=>{
        const hay = (lang==="ar"? x.ar : x.en).toLowerCase();
        return !query || hay.includes(query);
      }).slice(0, 6);

      items.forEach(x=>{
        const div = document.createElement("div");
        div.className = "miniItem";
        const title = document.createElement("div");
        title.textContent = (lang==="ar") ? x.ar : x.en;
        const a = document.createElement("a");
        a.href = x.url;
        a.textContent = (lang==="ar") ? "فتح" : "Open";
        div.appendChild(title);
        div.appendChild(a);
        list.appendChild(div);
      });
    }

    document.getElementById("archiveSearch").addEventListener("input", (e)=>{
      const lang = localStorage.getItem(STORAGE_KEY) || "en";
      renderMiniList(lang, e.target.value);
    });

    function addMessage(role, html){
      const chat = document.getElementById("chat");
      const row = document.createElement("div");
      row.className = "msg " + (role === "user" ? "user" : "bot");
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = html;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function showLoader(on){
      document.getElementById("loaderWrap").style.display = on ? "block" : "none";
    }

    function levelLabel(lang, lvl){
      const t = ui[lang];
      const map = {
        beginner: lang==="ar" ? "مبتدئ" : "Beginner",
        intermediate: lang==="ar" ? "متوسط" : "Intermediate",
        advanced: lang==="ar" ? "متقدم" : "Advanced",
      };
      return map[lvl] || map.beginner;
    }

    function escapeHTML(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    async function ask(){
      const input = document.getElementById("questionInput");
      const q = (input.value || "").trim();
      if(!q) return;

      const lang = localStorage.getItem(STORAGE_KEY) || "en";
      const bilingual = localStorage.getItem(STORAGE_BI) === "1";
      const t = ui[lang];

      addMessage("user", `<div>${escapeHTML(q)}</div>`);
      input.value = "";

      showLoader(true);
      document.getElementById("sendBtn").disabled = true;

      try{
        const r = await fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: q, lang })
        });

        const data = await r.json();

        const ansAr = data.answer_ar || "";
        const ansEn = data.answer_en || "";
        const ans = (lang === "ar") ? ansAr : ansEn;
        const lvl = data.level || "beginner";
        const era = data.year_or_era || (lang==="ar" ? "العصر الحديث" : "Modern era");
        const sources = Array.isArray(data.sources) ? data.sources : [];
        const links = Array.isArray(data.archive_links) ? data.archive_links : [];

        const answerBlock = ans ? escapeHTML(ans).replaceAll("\n","<br>") : `<span style="color:rgba(255,255,255,0.65)">${t.noAnswer}</span>`;

        let biBlock = "";
        if (bilingual){
          const other = (lang==="ar") ? ansEn : ansAr;
          if (other && other.trim()){
            biBlock = `
              <div style="margin-top:12px;opacity:.9">
                <div style="font-size:.85rem;color:rgba(255,255,255,0.65);margin-bottom:6px">${lang==="ar"?"الترجمة":"Translation"}</div>
                <div style="border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);padding:10px 12px;border-radius:14px;line-height:1.75">
                  ${escapeHTML(other).replaceAll("\n","<br>")}
                </div>
              </div>
            `;
          }
        }

        const badges = `
          <div class="meta-row">
            <span class="badge strong">${t.levelLabel}: ${levelLabel(lang, lvl)}</span>
            <span class="badge">${t.eraLabel}: ${escapeHTML(era)}</span>
          </div>
        `;

        const sourcesHtml = sources.length ? `
          <div style="margin-top:10px">
            <div style="color:rgba(255,255,255,0.65);font-size:.85rem;margin-bottom:6px">${t.sourcesLabel}</div>
            <div class="meta-row">
              ${sources.slice(0,6).map(s=> `<span class="badge">${escapeHTML(s)}</span>`).join("")}
            </div>
          </div>
        ` : "";

        const linksHtml = links.length ? `
          <div style="margin-top:10px">
            <div style="color:rgba(255,255,255,0.65);font-size:.85rem;margin-bottom:6px">${t.linksLabel}</div>
            <div class="links">
              ${links.slice(0,4).map(l=>{
                const title = (lang==="ar") ? l.title_ar : l.title_en;
                return `<a class="alink" href="${l.url}">${escapeHTML(title)}</a>`;
              }).join("")}
            </div>
          </div>
        ` : "";

        addMessage("bot", `
          <div>${answerBlock}</div>
          ${badges}
          ${sourcesHtml}
          ${linksHtml}
          ${biBlock}
        `);

      } catch(e){
        addMessage("bot", `<div style="color:rgba(255,255,255,0.75)">Failed to fetch: ${escapeHTML(e.message || "Error")}</div>`);
      } finally{
        showLoader(false);
        document.getElementById("sendBtn").disabled = false;
      }
    }

    document.getElementById("sendBtn").addEventListener("click", ask);
    document.getElementById("questionInput").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") ask();
    });

    document.getElementById("toggleBilingual").addEventListener("click", ()=>{
      const lang = localStorage.getItem(STORAGE_KEY) || "en";
      const t = ui[lang];
      const current = localStorage.getItem(STORAGE_BI) === "1";
      localStorage.setItem(STORAGE_BI, current ? "0" : "1");
      document.getElementById("toggleBilingual").textContent = current ? t.showBi : t.hideBi;
    });

    const saved = localStorage.getItem(STORAGE_KEY) || "en";
    setLang(saved, false);
    highlightActiveRoute();

    document.getElementById("btn-en").addEventListener("click", ()=> setLang("en"));
    document.getElementById("btn-ar").addEventListener("click", ()=> setLang("ar"));

    // Welcome message
    const startLang = localStorage.getItem(STORAGE_KEY) || "en";
    addMessage("bot", (startLang==="ar")
      ? "أهلًا! أنا ليلى. اسألني عن الجمباز الإيقاعي بأي صياغة: تحكيم، تدريب، أدوات، تاريخ، أو لاعبات."
      : "Hi! I’m LAILA. Ask anything about rhythmic gymnastics: judging, training, apparatus, history, or gymnasts."
    );
  </script>
</body>
</html>
