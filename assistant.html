<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LAILA | AI Assistant</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-main:#0e0f14; --bg-soft:#151722;
      --accent:#8b8df8; --accent-soft:#6f72e6;
      --text:#ffffff; --muted:rgba(255,255,255,0.74);
      --border:rgba(255,255,255,0.08);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --radius:18px; --radius-lg:22px;
      --ease:cubic-bezier(.2,.8,.2,1);
      --good:#46e6a5;
      --warn:#ffd56a;
      --bad:#ff6b86;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:"Montserrat",sans-serif;}
    body{
      background:radial-gradient(circle at top,#1a1c2d,var(--bg-main));
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* Ambient glow */
    .bg-glow{
      position:fixed;inset:-220px;
      background:
        radial-gradient(closest-side, rgba(139,141,248,0.14), transparent 60%) 12% 18%/520px 520px,
        radial-gradient(closest-side, rgba(111,114,230,0.10), transparent 60%) 88% 30%/560px 560px,
        radial-gradient(closest-side, rgba(139,141,248,0.08), transparent 60%) 55% 95%/620px 620px;
      pointer-events:none;
      z-index:-3;
      animation:floatGlow 10s var(--ease) infinite alternate;
      opacity:.9;
    }
    @keyframes floatGlow{from{transform:translate3d(0,0,0) scale(1);}to{transform:translate3d(0,-18px,0) scale(1.03);}}

    /* Subtle gymnastic ribbons + hoops animation (pure CSS) */
    .gym-bg{
      position:fixed; inset:0;
      pointer-events:none; z-index:-2;
      overflow:hidden;
      opacity:0.95;
    }

    .ribbon{
      position:absolute;
      width:520px; height:220px;
      border-radius:999px;
      filter:blur(0.2px);
      opacity:.18;
      border:1px solid rgba(139,141,248,0.22);
      background:
        radial-gradient(circle at 30% 40%, rgba(139,141,248,0.35), transparent 60%),
        radial-gradient(circle at 70% 60%, rgba(111,114,230,0.25), transparent 62%);
      transform:rotate(18deg);
      animation:ribbonFloat 9.5s var(--ease) infinite;
    }
    .ribbon::after{
      content:"";
      position:absolute; inset:18px;
      border-radius:999px;
      border:1px dashed rgba(255,255,255,0.10);
      opacity:.55;
    }
    @keyframes ribbonFloat{
      0%{transform:translate3d(-10%, -10%, 0) rotate(16deg) scale(1);}
      50%{transform:translate3d(6%, 8%, 0) rotate(22deg) scale(1.03);}
      100%{transform:translate3d(-4%, 14%, 0) rotate(18deg) scale(1.01);}
    }

    .hoop{
      position:absolute;
      width:360px; height:360px;
      border-radius:50%;
      border:1px solid rgba(139,141,248,0.22);
      box-shadow:0 0 0 10px rgba(139,141,248,0.05) inset;
      opacity:.14;
      animation:hoopDrift 12s var(--ease) infinite alternate;
    }
    .hoop::before{
      content:"";
      position:absolute; inset:26px;
      border-radius:50%;
      border:1px solid rgba(111,114,230,0.18);
      opacity:.8;
    }
    @keyframes hoopDrift{
      from{transform:translate3d(0,0,0) rotate(0deg) scale(1);}
      to{transform:translate3d(18px,-14px,0) rotate(14deg) scale(1.02);}
    }

    /* Header (same style) */
    header{
      position:sticky;top:0;z-index:50;
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(14,15,20,0.70);
      backdrop-filter:blur(14px);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:2px;font-size:1.05rem;user-select:none;}
    .brand .dot{
      width:10px;height:10px;border-radius:50%;
      background:linear-gradient(135deg,var(--accent),var(--accent-soft));
      box-shadow:0 0 0 6px rgba(139,141,248,0.12),0 0 26px rgba(139,141,248,0.35);
    }

    nav{display:none;align-items:center;gap:18px;}
    nav a{
      color:var(--muted);text-decoration:none;font-size:0.92rem;padding:10px 10px;border-radius:999px;
      transition:transform .18s var(--ease),color .18s var(--ease),background .18s var(--ease);
    }
    nav a:hover{
      color:var(--text);background:rgba(255,255,255,0.04);transform:translateY(-1px);
      box-shadow:0 0 0 1px rgba(139,141,248,0.14) inset;
    }
    nav a.active{
      color:var(--text);background:rgba(139,141,248,0.10);
      box-shadow:0 0 0 1px rgba(139,141,248,0.22) inset,0 14px 38px rgba(0,0,0,0.35);
    }

    .right{display:flex;align-items:center;gap:10px;}
    .lang button,.menu-btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,0.02);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      font-size:0.82rem;
      cursor:pointer;
      position:relative;overflow:hidden;
      transition:transform .18s var(--ease),box-shadow .18s var(--ease),background .18s var(--ease),border-color .18s var(--ease);
    }
    .lang button.active{
      border-color:transparent;
      background:linear-gradient(135deg,var(--accent),var(--accent-soft));
      box-shadow:0 16px 50px rgba(139,141,248,0.22);
    }
    .lang button:hover,.menu-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 0 0 1px rgba(139,141,248,0.16) inset,0 18px 60px rgba(0,0,0,0.35);
    }
    .tap-glow::after{
      content:"";position:absolute;inset:-60%;
      background:radial-gradient(circle,rgba(139,141,248,0.55),transparent 60%);
      transform:scale(0.2);opacity:0;
      animation:tap 520ms var(--ease) forwards;
      pointer-events:none;
    }
    @keyframes tap{
      0%{opacity:0;transform:scale(0.15);}
      35%{opacity:0.65;transform:scale(0.55);}
      100%{opacity:0;transform:scale(1.05);}
    }

    .menu-btn{display:inline-flex;align-items:center;gap:8px;}
    .menu-panel{
      position:fixed;top:68px;left:16px;right:16px;
      background:rgba(21,23,34,0.92);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      padding:12px;
      display:none;
      backdrop-filter:blur(16px);
      z-index:60;
    }
    .menu-panel a{
      display:block;padding:12px 12px;border-radius:14px;color:var(--muted);text-decoration:none;
      transition:background .18s var(--ease),color .18s var(--ease),transform .18s var(--ease);
    }
    .menu-panel a:hover{
      background:rgba(255,255,255,0.04);color:var(--text);transform:translateY(-1px);
      box-shadow:0 0 0 1px rgba(139,141,248,0.14) inset;
    }
    .menu-panel a.active{
      color:var(--text);background:rgba(139,141,248,0.10);
      box-shadow:0 0 0 1px rgba(139,141,248,0.22) inset;
    }

    main{max-width:1150px;margin:0 auto;padding:42px 18px 84px;}
    .fade-in{animation:fadeIn 520ms var(--ease) both;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}

    /* Hero */
    .hero{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
      max-width:1000px;
      margin:0 auto 16px;
      text-align:center;
    }
    .hero h1{
      font-size:2.05rem;
      line-height:1.25;
      margin-bottom:8px;
    }
    .hero p{
      color:var(--muted);
      font-size:0.98rem;
      line-height:1.75;
      max-width:780px;
      margin:0 auto;
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
      margin-top:18px;
    }

    .panel{
      background:rgba(21,23,34,0.86);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:0 26px 80px rgba(0,0,0,0.25);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute;inset:-60% -30%;
      background:radial-gradient(circle at 30% 30%, rgba(139,141,248,0.18), transparent 55%);
      opacity:.75;
      pointer-events:none;
    }

    /* Chat Header */
    .chat-head{
      position:relative;
      padding:16px 16px 14px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .chat-title{
      display:flex;flex-direction:column;gap:4px;
    }
    .chat-title strong{font-size:1rem; letter-spacing:.3px;}
    .chat-title span{font-size:0.86rem; color:var(--muted); line-height:1.45;}

    .status{
      display:inline-flex;align-items:center;gap:8px;
      font-size:0.82rem;
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
      position:relative;
    }
    .status-dot{
      width:8px;height:8px;border-radius:50%;
      background:rgba(255,255,255,0.20);
      box-shadow:0 0 0 4px rgba(255,255,255,0.05);
    }
    .status-dot.good{background:var(--good); box-shadow:0 0 0 5px rgba(70,230,165,0.10), 0 0 24px rgba(70,230,165,0.28);}
    .status-dot.warn{background:var(--warn); box-shadow:0 0 0 5px rgba(255,213,106,0.10), 0 0 24px rgba(255,213,106,0.28);}
    .status-dot.bad{background:var(--bad); box-shadow:0 0 0 5px rgba(255,107,134,0.10), 0 0 24px rgba(255,107,134,0.28);}

    /* Messages */
    .chat-body{
      position:relative;
      padding:16px;
      height:min(58vh, 560px);
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      scroll-behavior:smooth;
    }

    .msg{
      max-width:92%;
      border-radius:18px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
      line-height:1.7;
      font-size:0.95rem;
      position:relative;
      overflow:hidden;
      animation:pop 320ms var(--ease) both;
    }
    @keyframes pop{from{opacity:0;transform:translateY(6px) scale(0.99);}to{opacity:1;transform:none;}}
    .msg small{
      display:block;
      margin-top:8px;
      color:rgba(255,255,255,0.55);
      font-size:0.78rem;
    }

    .msg.user{
      margin-left:auto;
      background:linear-gradient(135deg, rgba(139,141,248,0.18), rgba(111,114,230,0.12));
      border-color:rgba(139,141,248,0.20);
      box-shadow:0 16px 44px rgba(0,0,0,0.22);
    }
    .msg.ai{
      margin-right:auto;
      background:rgba(255,255,255,0.03);
    }
    .msg.ai::before{
      content:"";
      position:absolute; inset:-60% -40%;
      background:radial-gradient(circle at 25% 35%, rgba(139,141,248,0.16), transparent 58%);
      opacity:.55;
      pointer-events:none;
    }

    /* Input */
    .chat-foot{
      position:relative;
      padding:14px 14px;
      border-top:1px solid rgba(255,255,255,0.06);
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
    }
    .input{
      width:100%;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
      color:var(--text);
      border-radius:16px;
      padding:12px 12px;
      outline:none;
      font-size:0.95rem;
      transition:border-color .18s var(--ease), box-shadow .18s var(--ease);
    }
    .input:focus{
      border-color:rgba(139,141,248,0.25);
      box-shadow:0 0 0 1px rgba(139,141,248,0.18) inset, 0 16px 50px rgba(0,0,0,0.25);
    }

    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      color:var(--text);
      padding:12px 14px;
      border-radius:999px;
      cursor:pointer;
      font-size:0.9rem;
      min-width:112px;
      transition:transform .18s var(--ease),box-shadow .18s var(--ease),background .18s var(--ease),border-color .18s var(--ease);
      position:relative; overflow:hidden;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn.primary{
      border-color:transparent;
      background:linear-gradient(135deg,var(--accent),var(--accent-soft));
      box-shadow:0 16px 50px rgba(139,141,248,0.18);
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(139,141,248,0.14) inset,0 18px 60px rgba(0,0,0,0.35);}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none; box-shadow:none;}

    /* Quick chips */
    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:12px 14px 0;
      position:relative;
      z-index:1;
    }
    .chip{
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
      color:rgba(255,255,255,0.82);
      padding:8px 10px;
      border-radius:999px;
      font-size:0.84rem;
      cursor:pointer;
      transition:transform .18s var(--ease), background .18s var(--ease), border-color .18s var(--ease);
      position:relative; overflow:hidden;
    }
    .chip:hover{
      transform:translateY(-1px);
      background:rgba(139,141,248,0.08);
      border-color:rgba(139,141,248,0.18);
    }

    /* Sidebar info panel */
    .side{
      padding:16px;
    }
    .side h3{font-size:1.02rem;margin-bottom:8px;}
    .side p{color:var(--muted);font-size:0.9rem;line-height:1.7;margin-bottom:12px;}
    .side .mini{
      display:grid; gap:10px;
    }
    .mini-card{
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
      border-radius:16px;
      padding:12px 12px;
      transition:transform .18s var(--ease), box-shadow .18s var(--ease), border-color .18s var(--ease);
    }
    .mini-card:hover{
      transform:translateY(-1px);
      border-color:rgba(139,141,248,0.18);
      box-shadow:0 18px 60px rgba(0,0,0,0.30);
    }
    .mini-card strong{display:block; font-size:0.92rem; margin-bottom:6px;}
    .mini-card span{display:block; color:var(--muted); font-size:0.86rem; line-height:1.6;}

    /* Loader typing dots */
    .typing{
      display:inline-flex; gap:6px; align-items:center;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:rgba(255,255,255,0.45);
      animation:bounce 900ms var(--ease) infinite;
    }
    .dot:nth-child(2){animation-delay:120ms;}
    .dot:nth-child(3){animation-delay:240ms;}
    @keyframes bounce{
      0%,100%{transform:translateY(0);opacity:.55}
      50%{transform:translateY(-5px);opacity:1}
    }

    /* Responsive */
    @media(min-width:900px){
      header{padding:16px 26px;}
      nav{display:flex;}
      .menu-btn{display:none;}
      .menu-panel{display:none !important;}
      main{padding:52px 26px 96px;}
      .hero h1{font-size:2.75rem;}
      .layout{grid-template-columns: 1.45fr .9fr; gap:16px;}
      .chat-body{height:min(62vh, 620px);}
    }

    [data-lang]{display:none;}
  </style>
</head>

<body>
  <div class="bg-glow"></div>

  <div class="gym-bg" aria-hidden="true">
    <div class="ribbon" style="top:8%; left:-6%;"></div>
    <div class="ribbon" style="top:52%; left:62%; width:560px; height:240px; opacity:.14; animation-duration:11.5s;"></div>
    <div class="hoop" style="top:18%; left:74%;"></div>
    <div class="hoop" style="top:64%; left:10%; width:300px; height:300px; opacity:.12; animation-duration:14s;"></div>
  </div>

  <header>
    <div class="brand"><span class="dot"></span><span>LAILA</span></div>

    <nav>
      <a href="index.html" data-route="index.html">Home</a>
      <a href="archive.html" data-route="archive.html">Archive</a>
      <a href="learn.html" data-route="learn.html">Learn</a>
      <a href="assistant.html" data-route="assistant.html">AI Assistant</a>
    </nav>

    <div class="right">
      <button class="menu-btn" id="menuBtn" type="button">Menu</button>
      <div class="lang">
        <button id="btn-en" type="button">EN</button>
        <button id="btn-ar" type="button">AR</button>
      </div>
    </div>
  </header>

  <div class="menu-panel" id="menuPanel">
    <a href="index.html" data-route="index.html">Home</a>
    <a href="archive.html" data-route="archive.html">Archive</a>
    <a href="learn.html" data-route="learn.html">Learn</a>
    <a href="assistant.html" data-route="assistant.html">AI Assistant</a>
  </div>

  <main class="fade-in">

    <section class="hero">
      <div data-lang="en">
        <h1>Ask LAILA</h1>
        <p>
          Your rhythmic gymnastics assistant — built on the Archive. Ask anything about apparatus, rules evolution,
          judging, and training basics. Clear answers. Modern UI. Fast.
        </p>
      </div>

      <div data-lang="ar">
        <h1>اسأل ليلى</h1>
        <p>
          مساعدك في الجمباز الإيقاعي — مبني على الأرشيف. اسأل عن الأدوات، تطور القوانين،
          التحكيم، وأساسيات التدريب. إجابات واضحة. تجربة حديثة. سريعة.
        </p>
      </div>
    </section>

    <section class="layout">

      <!-- CHAT -->
      <div class="panel">
        <div class="chat-head">
          <div class="chat-title">
            <strong data-lang="en">Rhythmic Gymnastics Intelligence</strong>
            <strong data-lang="ar">ذكاء الجمباز الإيقاعي</strong>
            <span data-lang="en">Ask naturally — LAILA understands different phrasing and synonyms.</span>
            <span data-lang="ar">اسأل بطريقتك — ليلى بتفهم صيغ مختلفة ومرادفات.</span>
          </div>

          <div class="status" id="statusPill" title="API status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Connecting…</span>
          </div>
        </div>

        <div class="chips" id="chipsRow">
          <button class="chip" type="button" data-q-en="Explain the judging system in rhythmic gymnastics." data-q-ar="اشرح نظام التحكيم في الجمباز الإيقاعي.">Judging / التحكيم</button>
          <button class="chip" type="button" data-q-en="What are the five apparatus and how are they used?" data-q-ar="إيه هي أدوات الجمباز الإيقاعي الخمسة وبتستخدم إزاي؟">Apparatus / الأدوات</button>
          <button class="chip" type="button" data-q-en="What is the difference between Difficulty and Execution?" data-q-ar="إيه الفرق بين الصعوبة والتنفيذ؟">D vs E</button>
          <button class="chip" type="button" data-q-en="Give a simple training plan for a beginner rhythmic gymnast." data-q-ar="اديني خطة تدريب بسيطة لمبتدئة جمباز إيقاعي.">Training / تدريب</button>
        </div>

        <div class="chat-body" id="chatBody" aria-live="polite">
          <!-- Initial message -->
          <div class="msg ai" id="welcomeMsg">
            <div data-lang="en">
              Hello — I’m LAILA. Ask me anything about rhythmic gymnastics. I will answer using the Archive.
              <small>Tip: try “How is a routine scored?”</small>
            </div>
            <div data-lang="ar">
              أهلًا — أنا ليلى. اسألني أي حاجة عن الجمباز الإيقاعي. هجاوبك اعتمادًا على الأرشيف.
              <small>جرب: "إزاي بيتحسب تقييم الجملة؟"</small>
            </div>
          </div>
        </div>

        <div class="chat-foot">
          <input class="input" id="questionInput" placeholder="Type your question…" autocomplete="off" />
          <button class="btn primary" id="sendBtn" type="button">
            <span data-lang="en">Ask</span>
            <span data-lang="ar">اسأل</span>
          </button>
        </div>
      </div>

      <!-- SIDE PANEL -->
      <div class="panel">
        <div class="side">
          <h3 data-lang="en">How LAILA answers</h3>
          <h3 data-lang="ar">ليلى بتجاوب إزاي</h3>

          <p data-lang="en">
            LAILA uses your Archive knowledge first. If something is missing, it will say so clearly.
            Keep questions specific for best results.
          </p>
          <p data-lang="ar">
            ليلى بتعتمد على معلومات الأرشيف أولًا. لو المعلومة مش موجودة، هتقول ده بوضوح.
            كل ما سؤالك يكون محدد، الإجابة تبقى أدق.
          </p>

          <div class="mini">
            <div class="mini-card">
              <strong data-lang="en">Examples</strong>
              <strong data-lang="ar">أمثلة</strong>
              <span data-lang="en">“Explain artistry in judging.”</span>
              <span data-lang="ar">"اشرح الجانب الفني في التحكيم."</span>
            </div>

            <div class="mini-card">
              <strong data-lang="en">Language</strong>
              <strong data-lang="ar">اللغة</strong>
              <span data-lang="en">Switch EN/AR anytime — your choice is saved.</span>
              <span data-lang="ar">تقدر تبدّل عربي/إنجليزي في أي وقت — والاختيار بيتحفظ.</span>
            </div>

            <div class="mini-card">
              <strong data-lang="en">Next upgrade</strong>
              <strong data-lang="ar">الترقية الجاية</strong>
              <span data-lang="en">Archive search + sources (page-level references).</span>
              <span data-lang="ar">بحث داخل الأرشيف + مصادر (إشارات للصفحات).</span>
            </div>
          </div>
        </div>
      </div>

    </section>
  </main>

  <script>
    // ====== CONFIG ======
    // ضع هنا دومين الـ Backend بتاعك (بدون /api/laila في الآخر)
    const API_BASE = "https://laila-ai-backend.vercel.app";
    const API_ENDPOINT = API_BASE + "/api/laila";

    const STORAGE_KEY = "laila_lang";

    // ====== UI HELPERS ======
    function addTapGlow(el){
      el.classList.remove("tap-glow");
      void el.offsetWidth;
      el.classList.add("tap-glow");
      setTimeout(()=> el.classList.remove("tap-glow"), 560);
    }

    function setLang(lang, persist=true){
      document.querySelectorAll("[data-lang]").forEach(el=>{
        el.style.display = (el.getAttribute("data-lang") === lang) ? "block" : "none";
      });
      document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";
      document.documentElement.lang = (lang === "ar") ? "ar" : "en";

      const btnEn = document.getElementById("btn-en");
      const btnAr = document.getElementById("btn-ar");
      btnEn.classList.toggle("active", lang === "en");
      btnAr.classList.toggle("active", lang === "ar");

      // placeholder
      const input = document.getElementById("questionInput");
      input.placeholder = (lang === "ar") ? "اكتب سؤالك هنا…" : "Type your question…";

      if(persist) localStorage.setItem(STORAGE_KEY, lang);
    }

    function highlightActiveRoute(){
      const file = (location.pathname.split("/").pop() || "index.html").toLowerCase();
      document.querySelectorAll("[data-route]").forEach(a=>{
        a.classList.toggle("active", a.getAttribute("data-route").toLowerCase() === file);
      });
    }

    function setStatus(state, text){
      const dot = document.getElementById("statusDot");
      const label = document.getElementById("statusText");

      dot.classList.remove("good","warn","bad");
      if(state === "good") dot.classList.add("good");
      if(state === "warn") dot.classList.add("warn");
      if(state === "bad")  dot.classList.add("bad");

      label.textContent = text;
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function appendMessage(role, html){
      const chatBody = document.getElementById("chatBody");
      const div = document.createElement("div");
      div.className = "msg " + role;
      div.innerHTML = html;
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
      return div;
    }

    function appendTyping(){
      const html = `
        <div class="typing" aria-label="Typing">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      `;
      return appendMessage("ai", html);
    }

    // ====== API ======
    async function ping(){
      try{
        const r = await fetch(API_ENDPOINT, { method:"GET" });
        if(!r.ok) throw new Error("Bad status");
        const j = await r.json();
        if(j && j.message){
          setStatus("good", "Online");
        }else{
          setStatus("warn", "Online");
        }
      }catch(e){
        setStatus("bad", "Offline");
      }
    }

    async function ask(question, lang){
      const r = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ question, lang })
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){
        const details = data?.details || data?.error || ("HTTP " + r.status);
        throw new Error(details);
      }
      return data.answer || "";
    }

    // ====== EVENTS ======
    const menuBtn = document.getElementById("menuBtn");
    const menuPanel = document.getElementById("menuPanel");
    function toggleMenu(){
      const open = menuPanel.style.display === "block";
      menuPanel.style.display = open ? "none" : "block";
    }
    menuBtn?.addEventListener("click", ()=>{
      addTapGlow(menuBtn);
      toggleMenu();
    });
    document.addEventListener("click", (e)=>{
      const inside = menuPanel.contains(e.target) || menuBtn.contains(e.target);
      if(!inside) menuPanel.style.display = "none";
    });

    document.querySelectorAll("button, a").forEach(el=>{
      el.addEventListener("click", ()=> addTapGlow(el));
    });

    // Chips
    document.getElementById("chipsRow").addEventListener("click", (e)=>{
      const chip = e.target.closest(".chip");
      if(!chip) return;
      const saved = localStorage.getItem(STORAGE_KEY) || "en";
      const q = (saved === "ar") ? chip.getAttribute("data-q-ar") : chip.getAttribute("data-q-en");
      const input = document.getElementById("questionInput");
      input.value = q;
      input.focus();
    });

    // Send
    const sendBtn = document.getElementById("sendBtn");
    const input = document.getElementById("questionInput");

    async function onSend(){
      const lang = localStorage.getItem(STORAGE_KEY) || "en";
      const q = (input.value || "").trim();
      if(!q) return;

      sendBtn.disabled = true;
      input.disabled = true;

      appendMessage("user", `<div>${escapeHTML(q)}</div><small>${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</small>`);
      input.value = "";

      const typingEl = appendTyping();

      try{
        setStatus("good", "Thinking…");
        const answer = await ask(q, lang);
        typingEl.remove();

        // Keep answer formatting simple (new lines)
        const safe = escapeHTML(answer).replaceAll("\n", "<br/>");
        appendMessage("ai", `<div>${safe}</div><small>${lang === "ar" ? "إجابة من ليلى" : "Answer from LAILA"}</small>`);

        setStatus("good", "Online");
      }catch(err){
        typingEl.remove();
        setStatus("warn", "Check");
        const msg = (lang === "ar")
          ? ("حصل خطأ أثناء الاتصال بالذكاء الاصطناعي. التفاصيل: " + err.message)
          : ("AI request failed. Details: " + err.message);

        appendMessage("ai", `<div>${escapeHTML(msg)}</div><small>${lang === "ar" ? "ملاحظة" : "Note"}</small>`);
      }finally{
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
        const chatBody = document.getElementById("chatBody");
        chatBody.scrollTop = chatBody.scrollHeight;
      }
    }

    sendBtn.addEventListener("click", onSend);
    input.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        onSend();
      }
    });

    // Language buttons
    document.getElementById("btn-en").addEventListener("click", ()=> setLang("en"));
    document.getElementById("btn-ar").addEventListener("click", ()=> setLang("ar"));

    // Init
    const saved = localStorage.getItem(STORAGE_KEY) || "en";
    setLang(saved, false);
    highlightActiveRoute();
    ping();
  </script>
</body>
</html>
